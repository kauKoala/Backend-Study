- 1일당 알림 발생 수
    - 모바일 푸시 알림: 1000만 개
    - SMS: 100만 개
    - 이메일: 500만 개
- 알림 종류: 푸시 알림, SMS, 이메일
- 실시간 여부: 연성 실시간 시스템
    - 기본적인 요구사항은 실시간이지만, 높은 부하가 생기면 약간의 지연이 있어도 무방한 시스템
- 보내는 단말: Android, IOS, 컴퓨터
- 누가 알람을 보낼지: 클라이언트 or 서버 스케줄링 모두 보낼 수 있음

## 알림 메커니즘 동작 방법

- Android: `알림 제공자 → FCM → Android 단말`
- IOS: `알림 제공자 → APNS → IOS 단말`
- SMS: `알림 제공자 → SMS 서비스 → SMS 수신 단말`
- 이메일: `알림 제공자 → 이메일 서비스 → 이메일 수신 단말`

여기에 대한 공통점은 모두 제3사업자 제공 서비스를 사용할 수 밖에 없는 점임

## 알림 전송 및 수신 절차의 초기 설계안

![image](https://github.com/user-attachments/assets/04507485-e8db-4c5d-99ac-9efd3917773c)

- N개의 서비스: 알림 시스템을 사용할 수 있는 서비스는 N개의 서비스여야 한다
    - 게임 알림
        - 이벤트가 있는 경우 이벤트 팀에서 알림 전송
        - 상점에 할인 상품이 있는 경우 상점 관련 팀에서 알림 전송
        - 인게임 재화 충전시 결제팀에서 알림 전송
        - 이외의 다양한 팀에서 알림 서비스를 이용할 수 있어야함
- 알림 시스템
    - 현재는 1개의 서버만 사용한다고 가정함
    - N개의 서비스를 위해 알림 전송을 위한 API를 제공해야함
    - API 요청이 들어오면 제3자 제공 서비스에게 전달할 페이로드를 만들어 내야함
- 제3자 서비스
    - 제3자가 만든 서비스를 사용하는 것이므로 내부는 건들 수 없음
    - 대신 확장성을 염두에 두고 더 나은 제3자 제공 서비스가 생기면 추가하거나, 기존 서비스를 삭제하 수 있어야함

### 발생할 수 있는 문제점

알림 시스템 서버가 1개이기 때문에 문제가 발생함

- SPOF: 알림 서비스가 단일 지점 장애 포인트가 될 수 있음
- 규모 확장성: 1대의 서비스로 푸시 알림과 관계된 모든 것을 처리하므로 디비와 캐시도 저 1대의 서비스 안에 있다고 가정함. 장비 하나로 모든걸 처리하므로 여러대의 캐시, 데이터베이스를 따로 구축하려면 설계 변경이 필요함
- 성능 병목: 제3자 서비스 응답을 받는데 오랜 시간이 걸릴 수 있음. 특히 트래픽이 몰리면 과부하가 생김

## 알림 전송 및 수신 절차의 개선 버전

![image](https://github.com/user-attachments/assets/15d599e9-9350-4900-8346-c1b1b44c784e)

- SPOF: 알림 서버를 증설함
- 규모 확장성: 디비와 캐시를 분리해서 따로 관리함
- 메시지 큐를 사용함
    - 강결합 제거 (시스템 컴포넌트간 의존성 제거)
    - 트래픽이 몰리면 버퍼 역할을 대신 수행해줌
    - 다른 제3자 서비스가 장애가 나도 다른 제3자 서비스는 동작할 수 있음

### 알림 서버 기능 분리

1대의 서버는 요청이 들어오면 모두 동작하도록 만들었던걸 기능을 분리함

- 알림 전송 API: 요청을 받을 수 있는 곳
- 알림 검증 (이메일, 전화번호에 대한 검증)
- 데이터베이스 / 캐시 질의
- 알림 전송: 이메일 큐에 넣는 기능 (여러개의 MQ를 사용하므로 병렬 처리 가능)

### 알림 전송 과정

1. 어드민이나 인증된 사용자가 `알림 전송 API`를 통해 요청함
2. 알림 서버는 사용자 정보 / 단말 토큰 / 알림 설정과 같은 정보를 `캐시 / 데이터베이스`에서 가져옴
3. 어떤 기기를 사용하는지 파악했으면 전송할 알림에 맞는 `이벤트를 만들어서 메시지 큐에 넣음`
4. 작업 서버는 `메시지 큐에서 알림 이벤트를 꺼내고, 제3자 서비스로 보냄`
5. 제3자 서비스는 사용자 단말로 알림을 전송함

## 알림 전송 및 수신 절차의 상세 설계

대략적인 설계는 만들어졌으므로 상세적인 설계를 진행함

### 1. 안정성

[1] 데이터 손실 방지

알림 전송 시스템의 중요한 점은 어떤 상황에서도 알림이 소실되면 안되는 것임 (지연은 괜찮음)

대비할 수 있는 방법은 알림 데이터를 디비에 보관하고 재시도 메커니즘을 구현해두어야함

[2] 알림 중복 전송 방지

분산 시스템 특성상 같은 데이터(요청, 알림, …)를 보내는걸 막는 것은 100% 불가능함

- 반복 전송 빈도를 최대한 줄이려면 중복 탐지 메커니즘을 도입하고 오류를 처리해야함
- 멱등적인 응답을 제공해야함
    - ex. 네비게이션을 사용하는데 좌회전만 하라고하면 사용자가 두번 알림을 받을 경우 완전히 잘못된 방향으로 나아감. 하지만 특정 장소에서 좌회전 하라고 이야기하면 고정된 곳에서 좌회전을 하라는 뜻이니 멱등성이 보장되어짐
    - ex. 데이터 등록과 관련된 POST 요청을 transaction ID를 요청에 포함하면 transaction ID는 고유한 번호이므로 중복 요청이 와도 한 번의 결과만 수행할 수 있도록 설계할 수 있음

→ 내부에서 처리 자체는 한 번으로 할 수 있지만 외부 시스템까지 바라볼 경우 완전한 한 번은 불가능함

### 2. 전송률 제한 / 재시도 방법

- 전송률 제한: 사용자가 알림을 너무 많이 받게 된다면 오히려 알림을 꺼버리거나, 서비스 이탈이 될 수 있으므로 사용자가 받을 수 있는 알림의 빈도를 제한함
- 재시도: 제3자 서비스가 알림 전송에 실패하면 재시도 할 수 있도록 전용 큐에 넣음

![image](https://github.com/user-attachments/assets/da16b9f6-340c-4c78-8443-d90f8ca38cd9)

이외에도 알림 모니터링, 데이터 분석을 위한 이벤트 추적, 알림 템플릿을 추가할 수 있음
