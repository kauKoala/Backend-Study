# 53. 공인 IP vs 사설 IP

공인 IP: 외부와 통신할 수 있는 주소. 나라마다 대역폭이 있다.

사설 IP: 특정 네트워크 내에서만 사용되는 IP주소. 네트워크가 다르면 동일한 IP가 있을 수 있다.

사설 IP 관련 네트워크엔 다음 것들이 있다.

- 인트라넷: 특정 조직, 기업 내에서만 접근 가능한 네트워크
- 독립망: 외부와 완전히 분리된 네트워크 ex) 군사 시설 등
- 폐쇄망: 독립망처럼 외부와 분리됐지만, 정책 등에 따라서 외부와 통신할 수는 있음

보안 관점에서 독립망이면 안전해 보이겠지만, 업데이트 상황에서 USB, CD 같이 외부 저장장치를 사용하는 경우도 있기 때문에 보안이 완벽하다고 말할 수 없다.

### 공인 IP 대역

- A 클래스: 1.0.0.0 ~ 126.0.0.0 / 호스트 16,777,214 개
- B 클래스: 128.0.0.0 ~ 191.255.0.0 / 호스트 65,534 개
- C 클래스: 192.0.0.0 ~ 223.255.255.0 / 호스트 254개

### CIDR(Classless Inter-Domain Routing)

클래스 기반 IP 할당 문제를 해결하기 위한 방법

**아이피 주소 / 네트워크 비트 수** 로 표기된다.

예를 들면, 300대의 기기를 사용하는 네트워크는 다음과 같이 표현할 수 있다. 이를 **CIDR 블록**이라고 한다.

> **192.0.0.0 / 23 (아이피 주소 / 네트워크 비트 수)**

기존 클래스 기반 할당에서는 B 클래스 대역 하나를 받아야 했다. C 클래스 대역 2개를 받으면 되지 않나? 란 생각을 할 수 있지만, 서브넷 마스크가 고정돼 네트워크를 합칠 수 없었다.

- 임의로 CIDR을 조절할 수 있나?
  - 공인 IP: 불가능하다. 지역 인터넷 레지스트리(RIR)이 관리하고 할당한다.
  - 사설 IP: 가능하다.

**사설 IP 대역**

- A 클래스: 10.0.0.0 ~ 10.255.255.255(10.0.0.0/8)
- B 클래스: 172.16.0.0 ~ 172.31.255.255(172.16.0.0/12)
- C 클래스: 192.168.0.0 ~ 192.168.255.255(192.168.0.0/16)

이 안에서도 서브넷 마스크를 통해서 더 많은 네트워크로 분할 할 수 있다.

### 호스트 개수 계산

호스트 비트 수만큼 2의 제곱을 하고, 거기서 2를 뺀다.

하나는 게이트웨이 주소고, 다른 하나는 브로드캐스트 주소이기 때문이다.

보통 첫 호스트를 게이트웨이 주소, 마지막 주소를 브로드캐스트 주소로 한다. 라우터 설정에 따라서 이를 조절할 수 있다.

## **사설 IP 할당**

- 동적 IP 할당: DHCP 서버에서 제공하는 IP를 사용한다. DHCP 서버는 라우터나 스위치 내에 내장돼 있지만, 직접 만들 수도 있다.
  - dhcp 서버에서 게이트웨이 정보도 같이 준다. 반면, 정적 IP 할당은 직접 입력해야 한다.
- 정적 IP 할당: 내가 직접 네트워크 통신에 필요한 정보를 입력한다.

여기서 할당된 동적 IP를 다른 기기에서 정적 IP 할당해버린 경우(알박기) 어떻게 하는지 찾아봤다.

원칙상으론 동적 IP 할당된 기기한테 새로운 주소를 준다고 하지만, 보통은 네트워크 관리자가 알아서 조절하는 것 같다.

카페, 공공장소 같이 관리자가 없는 경우엔 어떻게 할까 궁금했지만 너무 지엽적인 부분이라 생각해 건너뛰었다.

## **ARP**

네트워크 상에서 IP 주소를 MAC 주소와 대응시키기 위한 프로토콜

네트워크(와이파이 등) 에 연결되만 다음 작업을 수행한다.

1. 특정 주소와 통신할 상황이 생기면 "이 IP의 MAC 주소는 무엇입니까?" 란 ARP 브로드캐스트 발생
2. 해당 IP를 가진 기기는 자신의 MAC주소가 담긴 ARP reply를 유니캐스트로 보냄
3. ARP 테이블에 해당 정보를 업데이트해 이후 통신에선 ARP테이블을 보고 통신
4. 이후, ARP 테이블 엔트리가 타임아웃 되면 ARP 브로드캐스트를 보내 정보를 업데이트 한다.

**TMI**

ARP가 2계층으로 분류되지만, IP 정보 또한 다루기 때문에 이를 2.5계층이라고 보는 경우도 있다.

### **ARP 스푸핑**

네트워크 상에서 악의적인 기기가 패킷을 가로채는 행위. 다음 과정을 통해 공격이 성립된다.

1. 공격할 주소에게 게이트웨이 IP 주소, 자신의 MAC 주소가 담긴 reply를 보냄.
2. 공격당한 기기는 잘못된 정보를 가지고 ARP 테이블을 업데이트
3. 이후 모든 요청은 공격자의 기기로 전달됨

### **IP는 그대로인데?**

OSI 7 LAYER 기준으로 들자면 패킷을 외부로 전송하기 위해선

2계층 이더넷 프로토콜 -> 3계층 IP 프로토콜 순으로 올라간다.

내부 네트워크 통신은 2계층에서 발생한다. 따라서, 3계층 프로토콜인 IP 주소는 필요하지 않다. 그렇기 때문에, 2계층 이더넷 프로토콜에서 사용하는 MAC 주소만 보고 패킷을 전송한다.

정리하면

- MAC 주소: NIC에 고유하게 주는 주소로, 내부 네트워크간 통신에 사용
- IP 주소: 게이트웨이가 패킷을 외부로 보내기 위해 내부 기기를 식별하는 주소

### **어떻게 막을까?**

**arp -s를 통해 주소를 고정한다.**

고정을 하지 않아도 요즘 장비들이 좋아져서, 중복된 MAC 주소가 있으면 게이트웨이가 알아서 브로드캐스트를 하긴 한다.

### ARP 테이블과 라우팅 테이블은 같은 것인가?

결론부터 말하면 다르다. 각 테이블은 다음 정보들을 관리한다. 검색 결과 툴마다 보여주는 정보가 달랐기 때문에 공통적으로 보여주는 것만 정리했다.

**ARP 테이블**

- IP 주소
- MAC 주소

**라우팅 테이블**

- 목적지 주소
- 넥스트 홉(전송해야 할 라우터 주소)
- 비용

## **NAT(Network Address Translation)**

한 네트워크 주소를 다른 네트워크 주소로 변환하는 작업. 주로 사설 IP를 공인 IP로 변환하는 작업에 사용된다. 포트도 변환할 수 있다.

이를 통해 공인 IP를 절약하거나, 외부에서 내부 네트워크 IP를 알 수 없게 만드는 보안 향상도 있다.

- 내부 -> 외부 통신: 시작 주소를 공인 IP 주소 (아웃바운드)
- 외부 -> 내부 통신: 도착 주소를 원래 IP 주소 (인바운드)
  - 이더넷 프로토콜에 도착지 MAC 주소가 있기 때문에, 스위치에선 해당 MAC과 매칭되는 기기로 전달한다.

### **포트 포워딩**

외부에서 특정 IP 주소의 접근을 내부 네트워크의 IP와 포트 번호로 리다이렉션한다.

예를 들자면 도커에서 컨테이너의 IP, 포트를 직접 기입하지 않고, 외부 주소에 맞춰 전송해도 통신이 가능하다.

### **DMZ(Demilitarized Zone)**

외부, 내부 네트워크 중간에 있는 서브 네트워크

웹 서버같이 외부 접근이 필요한 서비스의 경우, 외부 접근을 허용하면서 내부 네트워크도 보호해야 하는 상황에 쓰인다.

**DMZ 쓰면 완전하게 막을 수 있나?**

다음 상황에선 문제가 될 수 있다.

- 잘못된 보안 정책
- 불필요한 서비스의 노출
  - 해당 서비스에 취약점이 발생한 경우 이를 통해 내부로 접근할 수 있다.

**IDS/IPS**

DMZ 보안을 강화하기 위한 시스템

IDS(Intrusion Detection System): 비정상적인 트래픽, 행위를 탐지하기 위한 시스템. 직접적으로 차단할 수는 없다.

IPS(Intrusion Prevention System): IDS에서 발생한 비정상적인 요청을 대응하기 위한 시스템. 접근을 막거나 다른 곳으로 우회시킬 수 있다.