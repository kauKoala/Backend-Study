# 97. AWS (VPC)



##  VPC(Virtual Private Cloud)란?

하지만 자체 서비스의 서버(was, db) 나 사내 전산 시스템을 운영할 경우 공용 네트워크에서의 접근을 제한하지 않는다면 중요한 서버들로 향하는 네트워크 접근들에 무방비해진다.

따라서 많은 경우 중요한 사내 시스템이나 서버들을 **사설 네트워크**안에 두게 된다. 직접 호스팅하는 서버나 시스템이라면 호스팅되는 위치에 네트워크를 직접 구성하면 되겠으나 AWS의 경우 **퍼블릭 클라우드**로 AWS에서 자체적으로 호스팅하고 관리하여 네트워크 구성 및 설정도 물론 사용자가 AWS를 통해 관리해야 한다.

사용자가  운용하고 있는 AWS에서 인프라들의 네트워크를 온프레미스 환경처럼 구성하고 설정할 수 있게끔  AWS가 제공해주는 서비스가 VPC다.

이미지 출처(https://velog.velcdn.com/images/ssonzm/post/0d1ad4d9-4bb9-4c64-9b4d-d720b9b1aa11/image.png)

![img](https://velog.velcdn.com/images/ssonzm/post/0d1ad4d9-4bb9-4c64-9b4d-d720b9b1aa11/image.png)

## VPC를 사용하는 이유?

- 보안
- 확장성

## VPC를 구성하는 요소들

이미지출처(https://velog.io/@ssonzm/AWS-Amazon-RDS%EC%99%80-VPC)

![img](https://velog.velcdn.com/images/ssonzm/post/9f51e280-2010-4826-9f4a-c0c08ea0dd8f/image.png)

### 서브넷

위에서 말했듯이 VPC는 간단하게 말해 AWS에서 제공해주는 논리적으로 격리된 자체 사설 네트워크이다. 따라서 VPC 내부에서는 해당 VPC에서 사용되는 자체적인 사설 IP대역이 존재한다.

- AWS VPC가 사용하는 사설 IP대역은 다음과 같다.
  - 10.0.0.0 ~ 10.255.255.255(10/8 prefix)
  - 172.16.0.0 ~ 172.31.255.255(182.16/12 prefix)
  - 192.168.0.0 ~ 192.168.255.255(192.168/16 prefix)

필요한 네트워크 구성에 따라 VPC를 만든다고 생각해보자

그렇게 된다면 같은 사설IP대역을 공유하는 네트워크 끼리의 통신이 될 것이며 그 과정과 구성은 매우 복잡해질 것이다.

따라서 VPC에서 사용하는 전체 사설IP대역을 목적에 따라 더 작은 그룹(사설 IP 대역)으로 나누는 것이 더 효율적이다. 

이를 **서브넷**이라 하며 크게 **퍼블릭 서브넷** 과 **프라이빗 서브넷**으로 나눌 수 있다.

![VPC](C:\Users\sj_13\Downloads\VPC.webp)

#### 퍼블릭 서브넷

공용네트워크(인터넷)을 통해 접근할 수 있으며 해당 서브넷에서도 인터넷에 접근할 수 있는 서브넷

- 퍼블릭 서브넷도 결국 사용하는 IP는 내부의 사설 IP이므로 결국 인터넷과 통신하기 위해서는 공인 IPV4가 필요하다. 이를 위해서는 해당 서브넷에 자동으로 IPV4할당 옵션을 켜야한다. 해당 옵션은 고정적인 공인 IPV4를 할당하는 것이 아니므로 (ELASTIC IP는 고정)  비용이 발생하지 않는다.

주로 3-Tier Architecture 에서 CLINET(WEB 서버)를 해당 서브넷에 위치시킨다.

#### 프라이빗 서브넷

공용 네트워크를 통해 접근할 수 없지만 내부 서브넷이나 특정 연결방법을 통해 접근할 수 있다. 인터넷 게이트웨이(NAT 게이트웨이)를 통해 공용 네트워크에 접근할 수 있다. 

주로 3-Tier Architecture 에서 APPLICATION(WAS 서버)를 해당 서브넷에 위치시킨다.



이외에도 공용 네트워크를 통해 접근할수도 없고 공용 네트워크에 접근하지도 못하는 서브넷을 만들어 DB 를 위치시킬수도 있다.



### 라우팅 테이블

서브넷내부에서만 사용되는 사설IP대역 밖에 모르는 VPC내의 서브넷은 공용네트워크 든 같은 VPC 내부에 있는 서브넷이든 다른 네트워크에 트래픽을 전달하기 위해서는  해당 IP가 어느 네트워크에 속해있는지 알아야한다. 이때 사용되는게 **라우팅 테이블**이다. 

AWS에서는 내부적으로 VPC에 서브넷을 추가할 때 마다 자동으로 다른 서브넷들의 라우팅 테이블에 해당 서브넷을 추가하며 추가하는 서브넷에도 다른 서브넷을 라우팅 테이블에 추가한다.



이미지출처(https://aws.amazon.com/ko/blogs/korea/inspect-subnet-to-subnet-traffic-with-amazon-vpc-more-specific-routing/)

![VPC 라우팅 구체화](https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2021/05/24/Slide1-e1621855971954-1024x584.png)

### 배스천 호스트(Bastion Host)

필요에 따라 공용 네트워크에서 인바운드 트래픽이 들어오지 못하게 막은 서브넷이 있다는 것을 알았다. 하지만 사용자가 외부에서 해당 서브넷을 관리하기 위해서 해당 서브넷에 접속해야 할 일도 있을 것이다. 이를 좀 더 안전하게 접속하기 위한 방식이 배스천 호스트다.

- 퍼블릭 서브넷에 배스천 호스트(ec2) 를 만든다. 
  - 위에서 설명했듯이 기본적으로 퍼블릭 서브넷에 서비스를 생성하면 퍼블릭 ip가 붙음
- 보안 그룹 설정
  - 프라이빗 서브넷에서는 배스천 호스트에 대한 ssh(22/tcp) 인바운드 트래픽을 허용하고
  - 배스천 호스트에서도 ssh(22/tcp) 인바운드 트래픽을 허용한다. 
- 각각 배스천 호스트와 프라이빗 서브넷에서 키페어를 만든다.(**2개**)
- 배스천 호스트에 **배스천 호스트의 키페어**를 통해 접속한후 배스천 호스트의 터미널에서 **프라이빗 서브넷의 키페어**를 통해 프라이빗 서브넷에 접근한다.

### 인터넷 게이트웨이

위에서 내부 사설 IP 대역에 불가한 퍼블릭 서브넷을 인터넷과 연결시켜주기 위한 직접적인 연결 수단이 인터넷 게이트웨이 이다.

인터넷 게이트웨이는 **인바운드/아웃바운드** 인터넷 통신이 모두 가능하여 어떤 서브넷의 라우팅 테이블에 인터넷 게이트웨이를 추가하게 된다면 이는 퍼블릭 서브넷이 된다.

- 인터넷 게이트웨이는 **한 VPC**에 속하게 된다. 여러 VPC가 한 인터넷 게이트웨이를 사용하지 못한다.
- 인터넷 게이트웨이는 한 AZ(가용영역)에 종속된 서브넷과 달리 여러 AZ에 분산되어 있다.

### NAT 게이트웨이

우리가 흔히 아는 NAT의 개념과 유사하며 프라이빗 서브넷이 공용 네트워크와 통신하기 위해 사용된다. 

공용 네트워크와 통신해야 하므로 **퍼블릭 서브넷**에 위치해서 프라이빗 서브넷의 트래픽을 외부로 전달해야 한다.

주의해야할점은 공용 네트워크에서 외부에서 NAT 게이트웨이를 통해 내부 VPC로 접근하는 것은 불가능하다.

- NAT 게이트웨이는 포폴용 단기성 사이드 프로젝트에서 부적합하다. NAT 게이트웨이는 트래픽양과 상관없이 온디맨드 요금으로 **매우 비싸므로** NAT 인스턴스를 이용하도록 하자..



**VPC ENDPOINT, NACL는 AWS(Security Group)이후에 해보겠음..** 

## 출처 및 참고

https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/what-is-amazon-vpc.html

https://inpa.tistory.com/entry/AWS-%F0%9F%93%9A-VPC-%EC%82%AC%EC%9A%A9-%EC%84%9C%EB%B8%8C%EB%84%B7-%EC%9D%B8%ED%84%B0%EB%84%B7-%EA%B2%8C%EC%9D%B4%ED%8A%B8%EC%9B%A8%EC%9D%B4-NAT-%EB%B3%B4%EC%95%88%EA%B7%B8%EB%A3%B9-NACL-Bastion-Host#%ED%8D%BC%EB%B8%94%EB%A6%AD_%EC%84%9C%EB%B8%8C%EB%84%B7%EC%97%90_public_ip_%EC%9E%90%EB%8F%99_%ED%95%A0%EB%8B%B9_%EC%84%A4%EC%A0%95

https://velog.io/@ssonzm/AWS-Amazon-RDS%EC%99%80-VPC
